---
title: "Verbal memory analysis"
author: "Jesse Cohen"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.show = TRUE, 
                      warning = FALSE, message = FALSE,
                      results = FALSE, tidy = TRUE,
                      fig.height = 8)

library(here)
library(tidyverse)
library(randomForest)
library(janitor)
library(rattle)
library(corrr)
library(lobstr)       # Inspect R data structures.
library(FSelector)    # Feature selection, information.gain().
library(stringi)      # String concat operator %s+%.
library(naniar)
library(magrittr)
library(ggpubr)
library(heatmaply)
library(DT)

source(here("munge.R"))

conflicts_prefer(corrr::correlate)

```
# Add BNT here - (confrontation naming)

# analysis of only both hippocampi summed
```{r Data Import Template, include=FALSE}
# input
verbal_testing_data <- read_rds(here("objects/clinical_testing/pvlt_cleaned_cases_and_controls.RDS"))

# Initialise the dataset as per the template.
dsname <- "verbal_testing_data"
ds     <- get(dsname)

ashs_clean <- read_rds("objects/ashs_summed_adjusted_for_icv.RDS") #changed to adjusted

# Select necessary columns from ashs_clean

ashs_clean %<>% select(-ad_marker) 
```

```{r Data Exploration, results = TRUE}
glimpse(ds)

# remove hvlt tests from ds
ds <- ds %>% select(-dplyr::contains("hvlt"))
```


# Verbal memory
Caveats with combining the two scores: as opposed to HVLT, PVLT looks at effect of distractors - after trial_ 5 adds a distractor list. Will z-score within each test within domains of learning (immediate recall), delayed recall (including "rapid forgetting index" of number on delayed recall:best immediate recall score), recognition (recognition discrimination index).
- Need to show consistent relationships between domains in HVLT vs PVLT in order to legitimize combining them 
- will use score closest in time to MRI that occurs after MRI, since in mediation analysis the cognitive test has to come after the MRI  

Steps:
1. find VLT closest to MRI date but occurring after
2. z-scores for each domain:
PVLT learning  - 1-5 trial_s total. also z-scores for each individual trial_ and then average those z scores
delayed - (Trial 9)
recognition - recognition discrimination score

HVLT learning - Total recall score. also z-scores for each individual trial_ then average those z scores
delayed - including Rapid forgetting index (%retained - measures what is lost between highest score in immediate recall and delayed recall)
recognition - recognition discrimination index 

--> subsequently can include MOCA/MMSE z-scores in the final model to adjust for global cognition


```{r verbal memory}
# find verbal memory test closest to mri date for each subject
verbal_date <- ashs_clean %>% 
  left_join(ds, by="inddid") %>%
  filter(diagnosis != "Normal") %>% 
  mutate(session_date = as.Date(session_date, format = '%Y%m%d'))

verbal_date %<>% 
  select(inddid, diagnosis, ad_present, session_date,  ageat_pvlt=ageat_test_1, pvlt_date = `test_date_1`, phl_correct_trial_1, phl_correct_trial_2, phl_correct_trial_3, phl_correct_trial_4, phl_correct_trial_5,
         phl_correct_15total, phl_correct_trial_9, phl_recognition_discrimin) %>%
  filter(is.na(phl_recognition_discrimin) == F) %>% #remove individuals who couldn't complete the test
  pivot_longer(cols = c("pvlt_date"), names_to = "test", values_to = "test_date") %>% 
  mutate(intvl_test = as.numeric(as.Date(test_date) - as.Date(session_date))/365) %>% distinct() %>% 
  filter(is.na(intvl_test)==F) %>% 
  #filter(abs(intvl_test) >= 0) %>% #this includes some tests that occurred before the MRI 
  group_by(inddid) %>% 
  slice_min(abs(intvl_test), with_ties = FALSE) %>%
  ungroup() 

# find inddids for whom there are multiple 
```


## Derive scores
```{r PVLT , results=TRUE}
data <- verbal_date %>% 
  rowwise() %>% 
  mutate(immediate_max = max(phl_correct_trial_1, phl_correct_trial_2, phl_correct_trial_3, phl_correct_trial_4, phl_correct_trial_5),
         remember_index = phl_correct_trial_9/immediate_max,
         immediate_mean = mean(phl_correct_trial_1, phl_correct_trial_2, phl_correct_trial_3, phl_correct_trial_4, phl_correct_trial_5)) 


df <- data %>% select(inddid, session_date, test_date, intvl_test, ageat_pvlt, p_total = immediate_mean, p_recall = phl_correct_trial_9, p_recog = remember_index) %>% 
  select(-contains("phl_correct_trial"))

```

# Correlation of scores with volumes
```{r correlation of VLT with subfield volumes}
pvlt_ashs <- df %>% left_join(ashs_clean) 

# remove columns that are not needed for correlation
ignore <- c("test_date", "yob", "session_year", "left_icv_adjusted")

# remove regions that are not adjusted for ICV
pvlt_ashs %<>% 
  select(inddid:flywheel_session_label,
  contains("adjusted"),
  -contains(c("misc", "sul", "meninges")),
  -any_of(ignore)) %>% distinct()

# correlation plot
p <- pvlt_ashs %>%
  corrr::correlate() %>%
  rearrange() %>%
  shave() %>% 
  rplot() 
  
p + guides(x = guide_axis(n.dodge = 2))

pvlt_ashs %>%
  correlate() %>%
  rearrange() %>% 
  focus(contains("p_")) 

pvlt_ashs %>%
  corrr::correlate() %>%
  shave() %>%
  stretch() %>%
  filter(abs(r) > 0.60) %>% 
  arrange(desc(r))

```

```{r}
pvlt_ashs %>%
  correlate() %>%
  network_plot()
```

# Correlation plots
```{r}
p_long_full_hippocampus <- 
pvlt_ashs %>% 
  select(`Immediate Recall` = p_total,
         `Delayed Recall` = p_recall,
         `Recognition Discrimination` = p_recog,
         `Hippocampal Volume` = bilat_full_hippocamp_adjusted, 
         `Case Status` = ad_present) %>% 
  pivot_longer(cols = contains(c("Recall", "Discrimination")),
               names_to = "test_component",
                           values_to = "score") %>% 
  pivot_longer(cols = "Hippocampal Volume",
               names_to = "region",
               values_to = "vol") %>% 
               mutate(score = ifelse(test_component == "Recognition Discrimination", score*10, score))

# # Multiply recognition-discrimination by 10 so that it's on similar scale to recall
# p_long_full_hippocampus %<>% 
#   mutate(score = ifelse(test_component == "Recognition Discrimination", score*10, score))

p_long_full_hippocampus$test_component %<>% fct_relevel("Immediate Recall", 
                                     "Delayed Recall",
                                     "Recognition Discrimination")



# Define the color palette
pal_okabe_ito <- c("#0072B2", "#009E73")

# Create the ggplot
gg <- ggplot(p_long_full_hippocampus, aes(vol, score, color = `Case Status`)) +
  geom_point() +
  facet_grid(cols = vars(test_component)) +
  stat_smooth(aes(fill = `Case Status`, color = `Case Status`), method = "lm") +
#  stat_cor(aes(color = NULL, label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), label.y = 12.1) +
#  stat_cor(aes(color = `Case Status`, label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), label.y.npc = "top") +
  labs(x = "Hippocampal Volume (%ICV)", y = "Philadelphia Verbal Learning Test Score", title = "Bilateral Hippocampal Volume and Verbal Memory Performance") +
  theme(legend.position = "top") # +
 # labs(caption = "Note: Recognition Discrimination scores were multiplied by 10 to be on a similar scale to recall scores.")

# Change the color palette for LBD-AD (blue) and LBD+AD (green)
gg <- gg + scale_color_manual(values = pal_okabe_ito, breaks = c("LBD-AD", "LBD+AD"), labels = c("LBD-AD", "LBD+AD")) +
  scale_fill_manual(values = pal_okabe_ito, breaks = c("LBD-AD", "LBD+AD"), labels = c("LBD-AD", "LBD+AD"))

# Make title and axis labels larger, also the facet labels
gg <- gg + theme(plot.title = element_text(size = 24),
                 axis.title.x = element_text(size = 24),
                 axis.title.y = element_text(size = 24),
                 strip.text = element_text(size = 16),
                 legend.text = element_text(size = 16))
print(gg)

# Create similar plots for each subfield of regions below:
regions <- c("bilat_ant_hippocamp_adjusted", "bilat_post_hippocamp_adjusted", 
"erc_median_thk_bilateral_adjusted",
"ba35_median_thk_biateral_adjusted",
"ba36_median_thk_biateral_adjusted",
"phc_median_thk_biateral_adjusted")

abbreviations <- c(
  "bilat_ant_hippocamp_adjusted" = "Anterior Hippocampus Volume (%ICV)",
  "bilat_post_hippocamp_adjusted" = "Posterior Hippocampus Volume (%ICV)",
  "erc_median_thk_bilateral_adjusted" = "ERC Median Thickness (%ICV)",
  "ba35_median_thk_biateral_adjusted" = "Br35 Median Thickness (%ICV)",
  "ba36_median_thk_biateral_adjusted" = "Br36 Median Thickness (%ICV)",
  "phc_median_thk_biateral_adjusted" = "PHC Median Thickness (%ICV)"
)

titles <- c(#"bilat_full_hippocamp_adjusted" = "Bilateral Whole Hippocampus Volume (adjusted for covariates)",
#  "bilat_ant_hippocamp_adjusted" = "Bilateral Anterior Hippocampus Volume (adjusted for covariates)",
#  "bilat_post_hippocamp_adjusted" = "Bilateral Posterior Hippocampus Volume (adjusted for covariates)",
  "erc_median_thk_bilateral_adjusted" = "Entorhinal Cortex",
  "ba35_median_thk_biateral_adjusted" = "Brodmann Area 35",
  "ba36_median_thk_biateral_adjusted" = "Brodmann Area 36",
  "phc_median_thk_biateral_adjusted" = "Parahippocampus"
)
# Define a function to pivot longer a data frame for each subregion for subsequent plotting

p_long <- function(region) {
  pvlt_ashs %>% 
    select(`Immediate Recall` = p_total,
           `Delayed Recall` = p_recall,
           `Recognition Discrimination` = p_recog,
           {{region}}, 
           `Case Status` = ad_present) %>% 
    pivot_longer(cols = contains(c("Recall", "Discrimination")),
                 names_to = "test_component",
                 values_to = "score") %>% 
    pivot_longer(cols = !!{{region}},
                 names_to = "region",
                 values_to = "vol") %>% 
    mutate(score = ifelse(test_component == "Recognition Discrimination", score * 10, score)) %>%
    mutate(test_component = factor(test_component, levels = c("Immediate Recall", "Delayed Recall", "Recognition Discrimination")))
}


# Create a list of data frames for each subregion
p_long_list <- lapply(regions[1:2], p_long)
p_long_list <- bind_rows(p_long_list)

p_long_list  %>% sample_frac()

# Plot each region in p_long_list similar to pvlt_hippo_plot, facetted by region and test_component
ant_post_hipp_plot <- ggplot(p_long_list, aes(vol, score, color = `Case Status`)) +
  geom_point() +
  facet_grid(cols = vars(test_component), rows = vars(region)) +
  stat_smooth(aes(fill = `Case Status`, color = `Case Status`), method = "lm") +
  stat_cor(aes(color = NULL, label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), label.y = 12.1) +
  stat_cor(aes(color = `Case Status`, label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), label.y.npc = "top") +
  labs(x = "Hippocampal Volume (%ICV)", y = "Philadelphia Verbal Learning Test Score", title = "Bilateral Hippocampal Volume and Verbal Memory Performance") +
  theme(legend.position = "top") +
  labs(caption = "Note: Recognition Discrimination scores were multiplied by 10 to be on similar scale to recall scores.")


# Create a list of data frames for each cortical region
p_long_list <- lapply(regions[3:length(regions)], p_long)
p_long_list <- bind_rows(p_long_list)

# Define the desired order of facet rows
desired_order <- c(#"bilat_full_hippocamp_adjusted",
#  "bilat_ant_hippocamp_adjusted",
#  "bilat_post_hippocamp_adjusted",
  "erc_median_thk_bilateral_adjusted",
  "ba35_median_thk_biateral_adjusted",
  "ba36_median_thk_biateral_adjusted",
  "phc_median_thk_biateral_adjusted")

# Convert the region variable to a factor with the desired order
p_long_list$region <- factor(p_long_list$region, levels = desired_order)

# Plot each region in p_long_list with facetted rows in the desired order
cortex_thk_plot <- ggplot(p_long_list %>% filter(test_component == "Delayed Recall"), aes(vol, score, color = `Case Status`)) +
  geom_point() +
  facet_grid(cols = vars(test_component), rows = vars(region), labeller = labeller(region = titles)) +
  stat_smooth(aes(fill = `Case Status`, color = `Case Status`), method = "lm") +
 # stat_cor(aes(color = NULL, label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), label.y = 12, label.x = 2e-06) +
 # stat_cor(aes(color = `Case Status`, label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), label.y.npc = "top", label.x = 2e-06) +
  labs(x = "Cortical Thickness (%ICV)", y = "", title = "Mesial Temporal Cortex and Verbal Memory Performance") +
  theme(legend.position = "top") +
  scale_color_manual(values = c("#0072B2", "#009E73")) +
  scale_fill_manual(values = c("#0072B2", "#009E73")) +
  theme(plot.title = element_text(size = 24),
        axis.title.x = element_text(size = 24),
        axis.title.y = element_text(size = 24),
        strip.text = element_text(size = 16),
        legend.text = element_text(size = 16))

# Display the ggplot
print(cortex_thk_plot)

```

# Partial correlation for age, sex, and education
```{r}
install.packages("ppcor")
library(ppcor)
install.packages("effects")
library(effects)
reg1 <- lm(pvlt_ashs$bilat_full_hippocamp_adjusted ~ pvlt_ashs$ageat_pvlt)   # run linear regression
resid1 <- resid(reg1)     # find the residuals - hippocampal vol free of age
reg2 <- lm(pvlt_ashs$p_total ~ pvlt_ashs$ageat_pvlt)   # second regression
resid2 <- resid(reg2)     # second set of residuals - verbal memory free of age
cor(resid1, resid2)       # correlation of residuals - partial correlation

# equivalent to 
pcor.test(pvlt_ashs$bilat_full_hippocamp_adjusted, pvlt_ashs$p_total, pvlt_ashs$ageat_pvlt)

# plot correlation adjusted for age 
mod_1 <- lm(p_total ~ bilat_full_hippocamp_adjusted + ageat_pvlt, data = pvlt_ashs)   # run linear regression
summary(mod_1)
summary(mod_1)$adj.r.squared

effect(term = "bilat_full_hippocamp_adjusted", mod = mod_1) %>% as_tibble()
```


# use this: library(correlation)
