---
title: "Confounders"
author: "Jesse Cohen"
date: '2022-12-14'
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r libraries, include=FALSE}
library(tidyverse)
library(here)
library(ggpubr)
library(heatmaply)

volumes_all <- readRDS(here("objects/mri_selected_ashs_all.RDS"))
clinical_clean <- readRDS(here("objects/id_dx_ad_present.RDS"))
mri_bids <- readRDS(here("objects/mri_bids_data_t1.RDS"))
```
```{r mri_bids collapse factors, dev='png'}

# mri_bids$DicomInstitutionName <- fct_lump_min(mri_bids$DicomInstitutionName, min = 30)


  volumes_all %>% filter(diagnosis=="Normal") %>% 
 keep(is.numeric) %>% 
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +  
  theme(axis.text.x = element_text(size = 4)) +
  facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_histogram(bins = 13) +
  theme(strip.text.x = element_text(size = 6))

  
    volumes_all %>% filter(diagnosis!="Normal") %>% 
 keep(is.numeric) %>% 
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +  
  theme(axis.text.x = element_text(size = 4)) +
  facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_histogram(bins = 13) +
  theme(strip.text.x = element_text(size = 6))
    
# x <- volumes_all[volumes_all$diagnosis=="Normal",] %>% 
#   keep(is.numeric) %>% cor(use="na.or.complete")

```


```{r}
ggplot(data = ashs_bids, aes(x= left_Anterior_hippocampus, fill = diagnosis=="Normal")) +
  geom_histogram()

ashs_bids %>% filter(left_Anterior_hippocampus >1600 & left_Anterior_hippocampus<1800) %>% 
  ggplot(data = ., aes(x= left_Anterior_hippocampus, fill = diagnosis=="Normal")) +
  geom_histogram()

ashs_bids %>% filter(left_Anterior_hippocampus >2200) %>% View()
ggplot(data = ., aes(x= left_Anterior_hippocampus, fill = diagnosis=="Normal")) +
  geom_histogram()
```
# Next to do:
1. QC on the images corresponding to the above outliers 

```{r}
volumes_all %>% filter(left_ICV < mean(left_ICV) - 2.5*sd(left_ICV))
volumes_all %>% filter(left_ICV > mean(left_ICV) + 2.5*sd(left_ICV))

volumes_all %>% filter(left_Anterior_hippocampus < mean(left_Anterior_hippocampus) - 2.5*sd(left_Anterior_hippocampus))
volumes_all %>% filter(left_Anterior_hippocampus > mean(left_Anterior_hippocampus) + 2.5*sd(left_Anterior_hippocampus))

```

2. get rid of YOB>1980 - completed 

```{r import data, include=FALSE}
ashs_bids <- volumes_all %>% 
  left_join(mri_bids) %>% 
  left_join(clinical_clean) %>% 
  distinct()
  

ashs_bids %>% 
 keep(is.numeric) %>% 
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +  
  theme(axis.text.x = element_text(size = 4)) +
  facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_histogram(bins = 13) +
  theme(strip.text.x = element_text(size = 6))

x <- ashs_bids[ashs_bids$diagnosis=="Normal",] %>% 
  keep(is.numeric) %>% cor(use="na.or.complete")

heatmaply_cor(x,
              xlab = "Features",
              ylab = "Features",
              k_col = 5,
              k_row = 5,
              main = "ASHS Output",
              fontsize_row =7,
              fontsize_col = 7)




cor()
confounders <- ashs_bids %>% 
  mutate(session_year = as.numeric(str_sub(FlywheelSessionLabel, 0,4))) %>% 
  group_by(INDDID, FlywheelSessionLabel) %>% 
  slice_head(n = 1) %>% 
  ungroup()
```



