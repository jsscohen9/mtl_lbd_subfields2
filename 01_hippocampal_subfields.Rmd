---
title: "Hippocampal Subfield Analysis: Ancova btwn LBD+AD, LBD-AD and controls"
author: "Jesse Cohen"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      include = FALSE)

rm(list = ls())
```

```{r packages}
library(tidyverse)
library(table1)
library(gridExtra)
library(modelr)
library(gtsummary)
library(viridis)
library(ggforce)
library(arsenal)
library(ggpubr)
library(MatchIt)
library(magrittr)
library(here)
library(randomForest)
library(janitor)
library(rattle)
library(corrr)
library(lobstr)       # Inspect R data structures.
library(FSelector)    # Feature selection, information.gain().
library(stringi)      # String concat operator %s+%.
library(DT)
library(ggpubr)
library(tidyverse)
library(broom)
library("lattice")
library(multcomp)
library("marginaleffects")
library(car)
library(cowplot)
library(easystats)
library(conflicted)
library(flextable)
library(officer)
library(webshot)
library(emmeans)
library(gridExtra)
library(lme4)
library(ggpubr)
library(ggstance)
library(scales)

conflicts_prefer(flextable::font)

# # Data
# 
# ## Study design: INDD Query
# 
# -   Prospectively collected clinical, biomarker and imaging data from INDD Queried INDD for individuals with at least 1 MRI available and:
# 
# -   Clinical diagnosis PD, PD-MCI, PDD, or DLB or
# 
# -   Or healthy control (MMSE >27 or CDR = 0, no self-history of neuropsych dz)
# 
# Query resulted in:
# 
# 920 MRI sessions (523 unique subjects)
# 
# ANTsCT cortical thickness pipeline 549 successful (312 unique subjects)
```

<!-- # Data Import -->

```{r munge, include=FALSE} 
conflicts_prefer(janitor::clean_names())
source(file = here("munge.R"))
source(file = here("ggplot_the_model.R"))
```

```{r initialize}
# input
file_name <- c("objects/mris_matched_cases_and_controls.RDS") #start with matched MRI sessions for cases/controls

# file_name <- c("objects/mris_matched_lbd_w_ad_vs_no_ad.RDS")
ds <- read_rds(file = file_name)
ds$session_year <- as.factor(ds$session_year)

# Use adjusted volumes:
ashs_summed_icv_adjusted <- read_rds(file = "objects/ashs_summed_adjusted_for_icv.RDS")
ashs_summed_icv_adjusted$session_year <- as.factor(ashs_summed_icv_adjusted$session_year)

# Use unadjusted volumes
# ashs_summed <- read_rds(file = "objects/ashs_summed_regions.RDS")
# ashs_summed$session_year <- as.factor(ashs_summed$session_year)

# Initialise the dataset as per the template.
dsname <- str_extract(string = file_name,pattern = regex("(?<=objects/)(.*)(?=.RDS)"))

# merge with df of ASHS summed and ICV adjusted output 

# Adjusted
ds %<>% left_join(ashs_summed_icv_adjusted)

# Unadjusted
# ds %<>% left_join(ashs_summed)

ds %>% sample_frac()

# Create new binary variable for when the date of the MRI was before May 1, 2017 when scanner was upgraded from timtrio # to prisma.
ds %<>% mutate(ses_pre_may_2017 = session_date < as.Date("2017-05-01"))

# ds %>% select(ses_pre_may_2017, session_date) %>% arrange(session_date)
# 
# ds$age_group <- cut(ds$age_at_mri, breaks = seq(20, 100, 10), right = FALSE)
# 
# dimensions <- read_delim(file = here("data/t1_filename_simples_all20230504_dimensions.txt"), col_names = c("file_name", "dimensions"))
# 
# # Split the filename_simple column into sub and ses columns
# dimensions[, c("inddid", "flywheel_session_label")] <- str_split_fixed(dimensions$file_name, "_ses-", 2)
# dimensions$inddid <- str_remove(dimensions$inddid, "^sub-")
# dimensions$flywheel_session_label <- str_remove(dimensions$flywheel_session_label, "_BrainSegmentation0N4.nii.gz$")
# 
# # Show the resulting data frame
# dimensions %<>% select(-file_name) 
# 
# my_new_column_names <- c("dim1", "dim2", "dim3")
# 
# # Use mutate() to split 'dimensions' into three columns
# x <- dimensions %>%
#   rowwise %>% 
#   mutate(dimensions = str_split_fixed(dimensions, "x", 3)) %>% 
#   pull(dimensions) 
# 
# dimension_split <- cbind(dimensions, x)
# 
# dimension_split %<>% mutate(dim_volume = as.numeric(`1`) *
#                              as.numeric(`2`) *
#                              as.numeric(`3`))
# 
# ds %<>% left_join(dimension_split)
# 
# as.factor(dim_volume)
# 
# ggplot(data = ds, aes(x = as.factor(round(dim_volume, 5)), y = left_icv, color = ad_present=="Control")) +
#   geom_jitter(alpha = 0.4,width = 0.1) +
#  geom_boxplot(alpha = 0.2) +
#   facet_grid(~sex) +
#   labs(x = "dim_volume", y = "ICV")
# 
# 
# ggplot(data = ds, aes(x = ad_present, y = bilat_full_hippocamp_adjusted)) +
#   geom_jitter(alpha = 0.2) +
#   geom_boxplot(alpha = 0.2) +
#   labs(x = "ad_present", y = "Bilat Full Hippocamp") +
#   facet_wrap(~sex + age_group) +
#   geom_hline(yintercept = mean(ds$bilat_full_hippocamp_adjusted), color = "red", linetype = "dashed")


```

```{r}
# # Merge with thickness data

# thickness <- read_rds(here("objects/ashs_thickness_median.RDS"))

# # extract date from flywheelsession_label (first 8 characters of the string)
# thickness$session_date <- str_extract(string = thickness$flywheel_session_label, pattern = regex("^[0-9]{8}"))

# # Convert to date format
# thickness$session_date <- as.Date(thickness$session_date, format = "%Y%m%d")

# # Pivot thickness data longer first collapsing regions into one column
# thickness <- thickness %>% 
#   pivot_longer(cols = -c(inddid, flywheel_session_label, session_date, side), names_to = "region", values_to = "thickness")

# # Combine region and side columns into one column
# thickness$region <- str_c(thickness$region, "_", thickness$side)

# # Remove side column
# thickness <- thickness %>% select(-side, -flywheel_session_label)

# # Then pivot wider (regions into columns)
# thickness <- thickness %>% 
#   pivot_wider(names_from = region, values_from = thickness)

# # Merge with ds by inddid and session_date
# ds %<>% left_join(thickness, by = c("inddid", "session_date"))
```

```{r}
# Quick look at distributions of thickness

ds %>% select(inddid, diagnosis, ad_present, sex, contains("thk")) %>% sample_frac()

# Plot all thk variables as histograms
ds %>% 
  select(contains("thk"), ad_present) %>% 
  tidyr::pivot_longer(cols = -ad_present, names_to = "region", values_to = "thickness") %>%
  ggplot(aes(x = thickness, color = ad_present)) +
  geom_histogram(bins = 15) +
  facet_wrap(~region, scales = "free") +
  theme_bw()

# Plot as boxplots by diagnosis
ds %>% select(contains("thk"), diagnosis) %>% 
  pivot_longer(cols = -diagnosis, names_to = "region", values_to = "thickness") %>% 
  ggplot(aes(x = diagnosis, y = thickness)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  facet_wrap(~region, scales = "free") +
  theme_bw()

# Plot as boxplots by diagnosis, normalizing thickness by dividing by "left_icv"
ds %>% select(contains("thk"), diagnosis, left_icv) %>% 
  pivot_longer(cols = -c(diagnosis, left_icv), names_to = "region", values_to = "thickness") %>% 
  ggplot(aes(x = diagnosis, y = thickness/left_icv)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  facet_wrap(~region, scales = "free") +
  theme_bw()

# Plot as boxplots by ad_present, normalizing thickness by dividing by left_icv
ds %>% select(contains("thk"), ad_present, left_icv) %>% 
  pivot_longer(cols = -c(ad_present, left_icv), names_to = "region", values_to = "thickness") %>% 
  ggplot(aes(x = ad_present, y = thickness/left_icv)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  facet_wrap(~region, scales = "free") +
  theme_bw()

# # Create new columns for thk_adjusted by dividing by left_icv
# ds %<>% mutate(across(contains("thk"), ~ .x/left_icv, .names = "{.col}_adjusted"))
# # Create vector of column names from ds that contain "thk"
# thk_cols <- ds %>% select(contains("thk")) %>% names()

# # Mutate new columns by adding together corresponding left and right columns
# ds %<>% mutate(hippo_median_thk_bilateral = hippo_median_thk_left + hippo_median_thk_right,
# erc_median_thk_bilateral = erc_median_thk_left + erc_median_thk_right,
# ba35_median_thk_biateral = ba35_median_thk_left + ba35_median_thk_right,
# ba36_median_thk_biateral = ba36_median_thk_left + ba36_median_thk_right,
# phc_median_thk_biateral = phc_median_thk_left + phc_median_thk_right,
# hippo_median_thk_bilateral_adjusted = hippo_median_thk_left_adjusted + hippo_median_thk_right_adjusted,
# erc_median_thk_bilateral_adjusted = erc_median_thk_left_adjusted + erc_median_thk_right_adjusted,
# ba35_median_thk_biateral_adjusted = ba35_median_thk_left_adjusted + ba35_median_thk_right_adjusted,
# ba36_median_thk_biateral_adjusted = ba36_median_thk_left_adjusted + ba36_median_thk_right_adjusted,
# phc_median_thk_biateral_adjusted = phc_median_thk_left_adjusted + phc_median_thk_right_adjusted)

# look at columns of _adjusted thickness with dlookr
ds %>% select(contains("adjusted")) %>%
  dlookr::diagnose() %>%  arrange(("missing_percent"))
  
```

```{r}
# Merge with T1 acquisition parameters to look for batch effects

t1_params <- read_rds(here("objects/t1_params.RDS"))

# ds %<>% left_join(t1_params)

# Look at only cases to see if there is an effect of protocol
# ds %<>% filter(diagnosis != "Normal")

# Mean icv volume by filename_simple
ds %>% 
  group_by(slice_thickness) %>% 
  summarize(mean_icv = mean(left_icv)) %>% 
  arrange(desc(mean_icv))

ds$manufacturers_model_name <- as.factor(ds$manufacturers_model_name)

# See if slice thickeness predicts icv after controlling for sex and age in linear regression
summary(lm(left_icv ~ (manufacturers_model_name=="Trio") + slice_thickness + (year<2017) + age_at_mri + ad_present, data = ds[ds$sex=="Male",]))

# Plot counts of manufacters_model_name by ad_present groups
ggplot(data = ds, aes(x = manufacturers_model_name, fill = ad_present)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "manufacturers_model_name", y = "Count")

# Plot average left_anterior_hippocampus by manufacturers_model_name
ggplot(data = ds, aes(x = manufacturers_model_name, y = left_anterior_hippocampus, color = ad_present)) +
  geom_jitter(alpha = 0.8) +
  geom_boxplot(alpha = 0.2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "manufacturers_model_name", y = "Left Anterior Hippocampus")

# Plot average left_anterior_hippocampus by slice_thickness
ggplot(data = ds, aes(x = as.factor(slice_thickness), y = left_anterior_hippocampus, color = ad_present)) +
  geom_jitter(alpha = 0.8) +
  geom_boxplot(alpha = 0.2) +
  labs(x = "slice_thickness", y = "Left Anterior Hippocampus")

# Test whether there is association between filename_simple and ad_present using t-test
# t.test(bilat_full_hippocamp ~ filename_simple=="T1w", data = ds)

# t.test(bilat_full_hippocamp_adjusted ~ filename_simple=="T1w", data = ds)

# # plot count of ad_present by filename_simple
# ggplot(data = ds, aes(x = filename_simple, fill = ad_present)) +
#   geom_bar() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#   labs(x = "filename_simple", y = "Count")
# 
# # Plot bilat_hippocamp by filename_simple
# ggplot(data = ds, aes(x = filename_simple, y = bilat_full_hippocamp, color = ad_present)) +
#   geom_jitter(alpha = 0.8) +
#   geom_boxplot(alpha = 0.2) +
#   labs(x = "filename_simple", y = "Bilat Full Hippocamp") +
#   geom_hline(yintercept = mean(ds$bilat_full_hippocamp), color = "red", linetype = "dashed")
# 
# # And adjusted for icv 
# ggplot(data = ds, aes(x = filename_simple, y = bilat_full_hippocamp_adjusted, color = ad_present)) +
#   geom_jitter(alpha = 0.8) +
#   geom_boxplot(alpha = 0.2) +
#   labs(x = "filename_simple", y = "Bilat Full Hippocamp Adjusted") +
#   geom_hline(yintercept = mean(ds$bilat_full_hippocamp_adjusted), color = "red", linetype = "dashed")
# 
# # Plot bilat_hippocamp by filename_simple as plotly box and whisker + dotplot showing inddid on hover; separating boxes and dots on x axis
# library(plotly)
# ds %>% 
#   plot_ly(x = ~filename_simple, y = ~bilat_full_hippocamp, color = ~ad_present, type = "box") %>%
#   add_markers(x = ~filename_simple, y = ~bilat_full_hippocamp, color = ~ad_present, alpha = 0.5, hoverinfo = "text", text = ~inddid) %>%
#   plotly::layout(xaxis = list(title = "filename_simple"), yaxis = list(title = "Bilat Full Hippocamp")) %>% 
#   plotly::layout(boxmode = "group") %>% 
#   plotly::layout(showlegend = FALSE) %>%
#   plotly::layout(hovermode = "closest") %>%
#   plotly::layout(hoverlabel = list(bgcolor = "white", font = list(family = "sans serif", size = 12, color = "black"))) %>%
#   plotly::layout(title = "Bilat Full Hippocamp by filename_simple")
# 
# 
# ds  %>% select(inddid, flywheel_session_label, ad_present, filename_simple, bids_filename_simple)
```

```{r}


# Remove all but filename_simple = "T1w" from ds
# ds %<>% filter(filename_simple == "T1w")
```

```{r , include=TRUE}
library(DT)
DT::datatable(ds)
```

# Results

```{r Density Plots numerical variables, results = 'asis', eval=FALSE}
## Density Plots numerical variables
ds %>%
  keep(is.numeric) %>%                     # Keep only numeric columns
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +  
  theme(axis.text.x = element_text(size = 4)) +
  facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_histogram() + 
  theme(strip.text.x = element_text(size = 6))


regions_to_keep <- c("yob", "education", "left_anterior_hippocampus")

ds %>% 
  colnames() %>%
  str_extract_all(".*_adjusted")
  
quick_boxplots <- function(df, nvars) {
  df %>%
  select({(nvars)}) %>% 
    pivot_longer(cols = {{nvars}}) %>% 
    ggplot(aes(value)) +  
  theme(axis.text.x = element_text(size = 4)) +
  facet_wrap(~ name, scales = "free") +   # In separate panels
    geom_histogram() + 
  theme(strip.text.x = element_text(size = 6))
}

ds %>%
  sapply(is.character) %>%
  which()  ->
chari

# Identify the character variables by name.

ds %>% 
  names() %>% 
  '['(chari) ->
charc


quick_boxplots(ds, regions_to_keep)
# #  %>%                     # Keep only numeric columns
#   pivot_longer() %>%         # Convert to key-value pairs
#   ggplot(aes(value)) +  
#   theme(axis.text.x = element_text(size = 4)) +
#   facet_wrap(~ key, scales = "free") +   # In separate panels
#     geom_histogram() + 
#   theme(strip.text.x = element_text(size = 6))
# }
```

```{r Boxplots numerical variables, results = 'asis', eval=FALSE}
## Boxplots numerical variables
# ds %>%
#   keep(is.numeric) %>%                     # Keep only numeric columns
#   gather() %>%                             # Convert to key-value pairs
#   ggplot(aes(value)) +                     # Plot the values
#     facet_wrap(~ key, scales = "free") + 
#     stat_boxplot(geom = "errorbar", width = 0.5) + # In separate panels
#     geom_boxplot()              +            # boxplot
#   theme(strip.text.x = element_text(size = 6))+
#   theme(axis.text.x = element_text(size = 4))
  
```

```{r Table 1}
#reorder levels for table display
naniar::any_na(ds$diagnosis)
ds$diagnosis <- factor(ds$diagnosis, 
                                 levels = c("DLB", "PDD", "PD", "Normal"))
naniar::any_na(ds$diagnosis)

ds$ad_present <- as.character(ds$ad_present)
ds$ad_present[ds$diagnosis == "Normal"] <- "Normal"
ds$ad_present %>% table()

ds$ad_present <- factor(ds$ad_present,
                             levels = c("Normal", "LBD-AD", "LBD+AD"),
                             labels = c("Control", "LBD-AD", "LBD+AD"))

ds$ad_present %>% table()

ds$ad_marker %<>% as.character() %>% as.factor()
ds$ad_marker <- factor(ds$ad_marker,
                          levels = c("autopsy", "autopsy_and_csf", "pet", "csf", "NA"),
                          labels = c("Autopsy", "Autopsy", "PET", "CSF", "Control"))


ds$session_year <- factor(ds$session_year)
```

### Table 1: Cases + Controls

```{r Print Table 1: Cases + Controls, include = TRUE, echo=FALSE}
#add labels
table1::label(ds$session_year) <- "Year of MRI"
table1::label(ds$ad_present) <- "AD+"
table1::label(ds$diagnosis) <- "Clinical Diagnosis"
table1::label(ds$age_at_mri) <- "Age at MRI"
table1::label(ds$sex) <- "Sex Assigned at Birth"
table1::units(ds$education) <- "years"
table1::label(ds$education) <- "Education"
table1::label(ds$race) <- "Self-Reported Race"
table1::label(ds$ad_marker) <- "AD Diagnostic"

caption <- c("")

table_1 <- table1(~ age_at_mri + sex + race + education + diagnosis + ad_marker| ad_present, data = ds, topclass="Rtable1-grid", )

table_1

conflicts_prefer(flextable::as_flextable)
# Output to word document
table_1 %>% as_tibble() %>%
  as_flextable() %>% 
  set_caption(caption) %>% 
  theme_booktabs() %>% 
  theme_box() %>% 
  autofit() %>% 
  align(align = "center", part = "all") %>% 
  align(align = "left", part = "header") %>% 
  align(align = "left", part = "body") %>% 
  bold(part = "header") %>% 
  font(fontname = "Times New Roman", part = "all") %>% 
  fontsize(size = 8, part = "all") %>% 
  autofit() 
```

```{r, include=TRUE, echo=FALSE}

saveRDS(ds, here("objects/hippocampal_subfields_df.RDS"))

cases_ids_sessions <- ds %>% filter(diagnosis!="Normal") %>% select(inddid, flywheel_session_label, bids_filename) %>% distinct()

write_csv(cases_ids_sessions, here("reports/cases_ids_sessions.csv"))

```

### Cases only

```{r print table 1 - Cases only, include=TRUE, echo=FALSE}
df_tbl1_marker <- ds %>% 
  #filter(diagnosis!="Normal") %>% 
  select(age_at_mri, sex, race, diagnosis, education, ad_marker, ad_present)

diagnose(df_tbl1_marker)

table_1_cases <- table1(~ age_at_mri + sex + race +  diagnosis + education + ad_marker | ad_present, data = df_tbl1_marker)

table_1_cases

# Add column of p-values for comparisons between AD+ and AD- across demographic variables
table_1_cases 

install.packages("compareGroups")

# Load the necessary packages
library(compareGroups)

compareGroups(ad_present ~ . , data = df_tbl1_marker)

# Generate table1 summary
table_1_cases <- table1(~ age_at_mri + sex + race + diagnosis + education + ad_marker | ad_present, data = df_tbl1_marker)

# Print the updated table
table_1_cases

```

```{r, include=TRUE, echo=FALSE}
```

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      include = TRUE)
```

## ANOVA of controls and cases

```{r include=TRUE, echo=TRUE}
ds 

ggplot(ds) +
  aes(x = ad_present, y = bilat_full_hippocamp_adjusted, color = ad_present) +
  geom_jitter() +
  theme(legend.position = "none")

# check normality
res_aov <- aov(bilat_full_hippocamp_adjusted ~ ad_present,
  data = ds
)

par(mfrow = c(1, 2)) # combine plots

# histogram
hist(res_aov$residuals)

# Equality of variances - homogeneity

# Boxplot
boxplot(bilat_full_hippocamp_adjusted ~ ad_present,
  data = ds
)

# Dotplot
dotplot(bilat_full_hippocamp_adjusted ~ ad_present,
  data = ds
)

group_by(ds, ad_present) %>%
  summarise(
    mean = mean(bilat_full_hippocamp_adjusted, na.rm = TRUE),
    sd = sd(bilat_full_hippocamp_adjusted, na.rm = TRUE)
  )


# Are hippocampal volumes different between the three groups 

# Anova
res_aov <- aov(bilat_full_hippocamp_adjusted ~ ad_present,
  data = ds
)

summary(res_aov)


# Tukey HSD test:
post_test <- glht(res_aov,
  linfct = mcp(ad_present = "Tukey")
)

summary(post_test)

```

# T test of LBD+AD vs LBD-AD

```{r}
# To look at cases only (i.e. compare just LBD+AD to LBD-AD):

ds_cases <- ds %>% filter(ad_present != "Control")
ggplot(ds_cases) +
  aes(x = ad_present, y = bilat_full_hippocamp_adjusted, color = ad_present) +
  geom_jitter() +
  theme(legend.position = "none")

# check normality
res_aov <- aov(bilat_full_hippocamp_adjusted ~ ad_present,
  data = ds_cases
)

par(mfrow = c(1, 2)) # combine plots

# histogram
hist(res_aov$residuals)

# Equality of variances - homogeneity (this assumption holds as long as 
# one sample variance is no larger than twice the size of the other)

# Boxplot
boxplot(bilat_full_hippocamp_adjusted ~ ad_present,
  data = ds_cases
)

# Dotplot
dotplot(bilat_full_hippocamp_adjusted ~ ad_present,
  data = ds_cases
)

group_by(ds_cases, ad_present) %>%
  summarise(
    mean = mean(bilat_full_hippocamp_adjusted, na.rm = TRUE),
    sd = sd(bilat_full_hippocamp_adjusted, na.rm = TRUE)
  )


# Are hippocampal volumes different between the  groups 

# T test
t_test <- t.test(bilat_full_hippocamp_adjusted ~ ad_present,
  data = ds_cases, var.equal = TRUE
)

t_test

# Anova (uncorrected for unequal variances) 
res_aov <- aov(bilat_full_hippocamp_adjusted ~ ad_present,
  data = ds_cases
)

summary(res_aov)

```

# Linear Model of just Full Bilateral Hippocampus

```{r include=T, echo=TRUE}
# Comparing controls and cases 
fit <- lm(bilat_full_hippocamp_adjusted  ~
            ad_present +
            age_at_mri +
                    sex +
                    education #+
          #  filename_simple
          #  diagnosis
          ,
          data = ds, weights = weights)


summary(fit) %>% coef()


# Add interactions to model for significant covariates 
fit_interactions <- lm(bilat_full_hippocamp_adjusted ~
            ad_present +
            age_at_mri +
                    # race +
                    sex +
                    #ses_pre_may_2017 + 
                    education +
            ad_present * (age_at_mri + 
                            sex +
                            education), data = ds, weights = weights)


summary(fit_interactions) %>% coef()

# Does it perform better?
# compare using an F-test with the anova() function
anova(fit, fit_interactions)

```

```{r}
#Estimate marginal means and plotting results
#fit: results on lm
#group: variable of interest
#adjust: method for multiple comparison corrections


# Fit the linear regression model
fit <- lm(bilat_full_hippocamp_adjusted ~ ad_present + age_at_mri + sex + education, data = ds, weights = weights)

emm1<-emmeans(fit, specs = pairwise ~ ad_present, 
              adjust = "none"
                            )

summary(emm1)

as.data.frame(emm1$emmeans)

as_tibble(emm1$contrasts)

effect_size <- as_tibble(eff_size(emm1, sigma = sigma(fit), edf = df.residual(fit))) %>% select(effect.size)

as_tibble(emm1$contrasts) %>% cbind(effect_size) %>% select(-df, -t.ratio)

```

# Plot of volume (adjusted for age, sex, and education)

```{r}
# This code is from Jeffrey Walker's digital text: https://www.middleprofessor.com/files/applied-biostatistics_bookdown/_book/plotting-models.html


# Define the color palette
pal_okabe_ito <- c("#b27700","#0072B2", "#009E73")

ggplot_the_response(fit, fit_emm = emm1$emmeans, fit_pairs = emm1$contrasts, 
                    y_label = "Hippocampal Volume (%ICV)",
                    x_label = "") + 
                    #labs(title = "Figure 1: Bilateral Hippocampal Volume")
                     panel_border() +
  geom_violin(aes(fill = ad_present), alpha = 0.5, trim = FALSE) +
  scale_fill_manual(values = c("#b27700", "#0072B2", "#009E73")) +
  theme_gray() +
  theme(text = element_text(size = 24), legend.position = NULL) + # Adjust the font size as needed
  coord_cartesian(ylim = c(0.2, 0.7)) 
 
# ggplot_the_model(fit, fit_emm = emm1$emmeans, fit_pairs = summary(emm1$contrasts, infer = TRUE), 
#                  y_label = "Hippocampal Volume (%ICV)")
```


```{r, echo=FALSE}
# All subfields
# Define a function to fit the linear model for each response variable
fit_lm <- function(response_var, data, weights) {
  formula <- as.formula(paste(response_var, "~ ad_present + age_at_mri + race + sex + education"))
  lm(formula, data = data, weights = weights)
}

regions <- c(#"bilat_full_hippocamp_adjusted", 
#"bilat_ant_hippocamp_adjusted",
 #            "bilat_post_hippocamp_adjusted", 
             "erc_median_thk_bilateral_adjusted",
"ba35_median_thk_biateral_adjusted",
"ba36_median_thk_biateral_adjusted",
"phc_median_thk_biateral_adjusted")

titles <- c(#"bilat_full_hippocamp_adjusted" = "Bilateral Whole Hippocampus Volume (adjusted for covariates)",
#  "bilat_ant_hippocamp_adjusted" = "Bilateral Anterior Hippocampus Volume (adjusted for covariates)",
#  "bilat_post_hippocamp_adjusted" = "Bilateral Posterior Hippocampus Volume (adjusted for covariates)",
  "erc_median_thk_bilateral_adjusted" = "Entorhinal Cortex",
  "ba35_median_thk_biateral_adjusted" = "Brodmann Area 35",
  "ba36_median_thk_biateral_adjusted" = "Brodmann Area 36",
  "phc_median_thk_biateral_adjusted" = "Parahippocampal Cortex"
)

abbreviations <- c(
 # "bilat_full_hippocamp_adjusted" = "Whole Hippocampus Volume (%ICV)",
 # "bilat_ant_hippocamp_adjusted" = "Anterior Hippocampus Volume (%ICV)",
 # "bilat_post_hippocamp_adjusted" = "Posterior Hippocampus Volume (%ICV)",
  "erc_median_thk_bilateral_adjusted" = "Median Thickness (%ICV)",
  "ba35_median_thk_biateral_adjusted" = "Median Thickness (%ICV)",
  "ba36_median_thk_biateral_adjusted" = "Median Thickness (%ICV)",
  "phc_median_thk_biateral_adjusted" = "Median Thickness (%ICV)"
)

# Fit the linear model for each response variable
models <- lapply(regions, fit_lm, data = ds, weights = weights)
names(models) <- regions # Set the names of the list to the region names

# Calculate emmeans for each response variable
emmeans_results <- lapply(names(models), function(model_name) {
  model <- models[[model_name]]
  ref_levels <- levels(ds$ad_present)[!is.na(levels(ds$ad_present))]
  ref_grid <- list(ad_present = ref_levels)
  emm <- emmeans(model, specs = pairwise ~ ad_present, ref_grid = ref_grid,
                 adjust = "tukey")
  fit_emm <- emm$emmeans
  fit_pairs <- emm$contrasts
  y_label <- model_name  # Set y_label to the model name
  ggplot_the_response(
    fit = model,
    fit_emm = fit_emm,
    fit_pairs = fit_pairs,
    y_label = abbreviations[model_name],
    x_label = ""
  ) + labs(title = titles[model_name]) + panel_border() +   geom_violin(aes(fill = ad_present), alpha = 0.5, trim = FALSE) +
  scale_fill_manual(values = c("#b27700", "#0072B2", "#009E73")) 
})

# Add light gridlines
emmeans_results <- lapply(emmeans_results, function(p) {
  p +  theme_gray() +
  theme(legend.position = "none",
  axis.title.y = element_blank(),
  axis.title.x = element_blank()
  )
})


# Arrange plots
grid.arrange(grobs = emmeans_results, ncol = 2)


emmeans_results
```

# Table of comparisons btwn marginal means
```{r, echo=FALSE}
# Redefine "abbreviations"
abbreviations <- c(
 # "bilat_full_hippocamp_adjusted" = "Whole Hippocampus Volume (%ICV)",
 # "bilat_ant_hippocamp_adjusted" = "Anterior Hippocampus Volume (%ICV)",
 # "bilat_post_hippocamp_adjusted" = "Posterior Hippocampus Volume (%ICV)",
  "erc_median_thk_bilateral_adjusted" = "Entorhinal Cortex Median Thickness (%ICV)",
  "ba35_median_thk_biateral_adjusted" = "Brodmann Area 35 Median Thickness (%ICV)",
  "ba36_median_thk_biateral_adjusted" = "Brodmann Area 36 Median Thickness (%ICV)",
  "phc_median_thk_biateral_adjusted" = "Parahippocampal Cortex Median Thickness (%ICV)"
)
 
# Create a table of the same data:


# Make table of marginal means displayed as "mean +/- SE"
emmeans(fit, specs = ~ ad_present, adjust = "none") %>% 
summary() 

  


# make contrast table
contrasts <-  emm1 %>%
  .$contrasts %>%
  data.frame() %>%
  mutate_if(is.numeric, function(x)round(x, 6)) %>% 
  select(-df) #%>%
  #mutate_all(as.character)


# make contrast table and include the effect size by using "eff_size(emm1, sigma = sigma(fit), edf = df.residual(fit))"
contrasts <-  emm1 %>% 
  .$contrasts %>%
  data.frame() %>%
  mutate_if(is.numeric, function(x)round(x, 6)) %>% 
  select(-df) 


eff_size(emm1, sigma = sigma(fit), edf = df.residual(fit)) %>% data.frame() %>%
mutate_if(is.numeric, function(x)round(x, 6)) %>% 
select(effect.size) %>% cbind(contrasts, .) -> contrasts

# transpose the dataframe and set the column names
transposed_contrasts <- t(contrasts)
colnames(transposed_contrasts) <- transposed_contrasts[1, ]
transposed_contrasts <- transposed_contrasts[-1, ]

transposed_contrasts <- as.data.frame(transposed_contrasts)

```

```{r, echo=FALSE}
# Print the flextable
# super_fp
super_fp <- fp_text(vertical.align = "superscript", font.size = 8, font.family = 'Times')

# italics_fp
italic_fp <- fp_text(italic = TRUE, font.size = 16, font.family = 'Times')

flextable(contrasts) %>%
  flextable::align(align = 'center', part = 'all') %>%
  flextable::align(align = 'left', j = 'contrast', part = 'all') %>%
  set_header_labels(t.ratio = "t ratio",
                    p.value = "p value",
                    contrast = "Comparison",
                    estimate = "Estimate") %>%
  add_footer_row(., colwidths = ncol(contrasts), values = '') %>%
  set_caption("Bilateral Hippocampal volume (adjusted for covariates)") %>% 
#  flextable::compose(., j = "df", part = "header", 
#          value = as_paragraph(as_chunk("d.f.", props = italic_fp))) %>%
  flextable::compose(., j = "contrast", part = "footer", 
          value = as_paragraph('P values were adjusted using the Tukey method for comparing a family of 3 estimates')) %>%
  flextable::font(fontname = 'Times', part = 'all') %>%
  fontsize(size = 12, part = 'all') %>%
  autofit() %>%
  bold(i = ~ p.value < 0.05, j = ~ p.value) %>%
  padding(padding.top = 5, part = 'footer')




```

# All subfields

<!-- # Table of emmeans for each region -->
# Table 2:
```{r, echo=FALSE, include=FALSE}
result_list <- lapply(names(models), function(model_name) {
  model <- models[[model_name]]
  ref_levels <- levels(ds$ad_present)[!is.na(levels(ds$ad_present))]
  ref_grid <- list(ad_present = ref_levels)
  emm <- emmeans(model, specs = pairwise ~ ad_present, ref_grid = ref_grid,
                 adjust = "tukey")
  fit_emm <- emm$emmeans
  fit_pairs <- emm$contrasts
  region_name <- model_name
  
  # store the fit_emm and fit_pairs results in a list
  list(region = region_name, fit_emm = fit_emm, fit_pairs = fit_pairs)
})

# Create a list of tables
emm_table_list <- lapply(result_list, function(res) {
  cbind(res$region, as.data.frame(res$fit_emm))
})

# Combine all tables into a single table
emm_combined_table <- do.call(rbind, emm_table_list)

emm_combined_table <- emm_combined_table %>% 
  mutate(`res$region` = recode(`res$region`, !!!abbreviations)) %>% 
  group_by(`res$region`) %>% select(-df) #%>% 
 # mutate_if(is.numeric, function(x)round(x, 3))

# Change the column names use dplyr::rename()
emm_combined_table %<>% rename("Mean" = emmean,
                    "Lower CI"= lower.CL,
                    "Upper CI"= upper.CL)

# Pivot longer everything except the region and ad_present columns
emm_combined_table <- emm_combined_table %>% 
  pivot_longer(cols = -c(`res$region`, ad_present), names_to = "stat", values_to = "value")

# Pivot wider so each value of ad_present is a column
emm_combined_table <- emm_combined_table %>% 
  pivot_wider(names_from = ad_present, values_from = value)

# Change numerics to scientific notation
emm_combined_table <- emm_combined_table %>% 
  mutate_if(is.numeric, function(x)format(x, scientific = TRUE, digits = 2))

# Print the flextable
flextable(emm_combined_table) %>%
  flextable::align(align = 'center', part = 'all') %>%
  set_header_labels(`res$region` = "Subfield",
                    stat = "Statistic") %>%
  add_footer_row(., colwidths = ncol(emm_combined_table), values = '') %>%
#  flextable::compose(., j = "df", part = "header", 
#          value = as_paragraph(as_chunk("d.f.", props = italic_fp))) %>%
 flextable::font(fontname = 'Times', part = 'all') %>%
  fontsize(size = 12, part = 'all') %>%
  autofit() %>%
  padding(padding.top = 5, part = 'footer')  %>% 
  merge_v(j=1) %>% 
  theme_vanilla()

```

# Table of comparisons

```{r, echo=FALSE}
# Create a list of tables
pairs_table_list <- lapply(result_list, function(res) {
  cbind(res$region, as.data.frame(res$fit_pairs))
})

# Combine all tables into a single table
pairs_combined_table <- do.call(rbind, pairs_table_list)

# replace values with abbreviations
pairs_combined_table <- pairs_combined_table %>% 
  mutate(`res$region` = recode(`res$region`, !!!abbreviations)) %>% 
  group_by(`res$region`) %>%
  select(-df, -t.ratio, -SE) %>% 
  mutate_if(is.numeric, function(x)round(x, 3))

# Print the flextable
ft_comparisons <- flextable(pairs_combined_table) %>%
  flextable::align(align = 'center', part = 'all') %>%
  flextable::align(align = 'left', j = 'contrast', part = 'all') %>%
  set_header_labels(`res$region` = "Subfield",
#                    t.ratio = "t ratio",
                    p.value = "p value",
                    contrast = "Comparison",
                    estimate = "Estimate") %>%
  add_footer_row(., colwidths = ncol(pairs_combined_table), values = '') %>%
#  flextable::compose(., j = "df", part = "header", 
#          value = as_paragraph(as_chunk("d.f.", props = italic_fp))) %>%
  flextable::compose(., j = "contrast", part = "footer", 
          value = as_paragraph('P values were adjusted using the Tukey method for comparing a family of 3 estimates')) %>%
  flextable::font(fontname = 'Times', part = 'all') %>%
  fontsize(size = 12, part = 'all') %>%
  autofit() %>%
  bold(i = ~ p.value < 0.05) %>%
  padding(padding.top = 5, part = 'footer')

ft_comparisons <- merge_v(ft_comparisons, j = 1)
theme_vanilla(ft_comparisons)

```

# All subfields by laterality

```{r echo=FALSE}
# Define a function to fit the linear model for each response variable
fit_lm <- function(response_var, data, weights) {
  formula <- as.formula(paste(response_var, "~ ad_present + age_at_mri + race + sex + education"))
  lm(formula, data = data, weights = weights)
}

# select regions 
adjusted_right_left_colnames <- grep("(right|left).*adjusted", colnames(ds), value=TRUE, perl=TRUE)

# Remove names that include "full_hippocampus"
adjusted_right_left_colnames <- adjusted_right_left_colnames[!grepl("full_hippocampus|icv", adjusted_right_left_colnames)]


left_cols <- grep("left", adjusted_right_left_colnames)
right_cols <- grep("right", adjusted_right_left_colnames)
sorted_colnames <- c(rbind(adjusted_right_left_colnames[right_cols], 
                            adjusted_right_left_colnames[left_cols]))

regions <- sorted_colnames

abbreviations <- c(
  "right_anterior_hippocampus_adjusted" = "R Anterior Hippocampus",
  "left_anterior_hippocampus_adjusted" = "L Anterior Hippocampus",
  "right_posterior_hippocampus_adjusted" = "R Posterior Hippocampus",
  "left_posterior_hippocampus_adjusted" = "L Posterior Hippocampus",
  "right_erc_adjusted" = "R ERC",
  "left_erc_adjusted" = "L ERC",
  "right_br_35_adjusted" = "R BA35",
  "left_br_35_adjusted" = "L BA35",
  "right_br_36_adjusted" = "R BA36",
  "left_br_36_adjusted" = "L BA36",
  "right_phc_adjusted" = "R PHC",
  "left_phc_adjusted" = "L PHC"
)

# Example usage:
region_name <- "right_anterior_hippocampus_adjusted"
abbreviation <- abbreviations[region_name]
# The value of abbreviation will be "R Anterior Hippocampus"


# Fit the linear model for each response variable
models <- lapply(regions, fit_lm, data = ds, weights = weights)
names(models) <- regions # Set the names of the list to the region names

emm_combined_table %>% 
  mutate(`res$region` = recode(`res$region`, !!!abbreviations)) %>% 
  group_by(`res$region`) %>% 
DT::datatable()

# Calculate emmeans for each response variable
plots <- lapply(names(models), function(model_name) {
  model <- models[[model_name]]
  ref_levels <- levels(ds$ad_present)[!is.na(levels(ds$ad_present))]
  ref_grid <- list(ad_present = ref_levels)
  emm <- emmeans(model, specs = pairwise ~ ad_present, ref_grid = ref_grid,
                 adjust = "tukey")
  fit_emm <- emm$emmeans
  fit_pairs <- emm$contrasts
  y_label <- model_name  # Set y_label to the model name
  ggplot_the_response(
    fit = model,
    fit_emm = fit_emm,
    fit_pairs = fit_pairs,
    y_label = abbreviations[model_name]
  )
})

# Display plots
gridExtra::grid.arrange(grobs = plots[1:4], ncol = 2)

gridExtra::grid.arrange(grobs = plots[5:8], ncol = 2)

gridExtra::grid.arrange(grobs = plots[9:12], ncol = 2)
```

# Table of comparisons

```{r, echo=FALSE}

# make contrast table
contrasts <-  emm1 %>%
  .$contrasts %>%
  data.frame() %>%
  mutate_if(is.numeric, function(x)round(x, 6)) %>% 
  select(-df) #%>%
  #mutate_all(as.character)


# make contrast table and include the effect size by using "eff_size(emm1, sigma = sigma(fit), edf = df.residual(fit))"
contrasts <-  emm1 %>% 
  .$contrasts %>%
  data.frame() %>%
  mutate_if(is.numeric, function(x)round(x, 6)) %>% 
  select(-df) 


eff_size(emm1, sigma = sigma(fit), edf = df.residual(fit)) %>% data.frame() %>%
mutate_if(is.numeric, function(x)round(x, 6)) %>% 
select(effect.size) %>% cbind(contrasts, .) -> contrasts

# transpose the dataframe and set the column names
transposed_contrasts <- t(contrasts)
colnames(transposed_contrasts) <- transposed_contrasts[1, ]
transposed_contrasts <- transposed_contrasts[-1, ]

transposed_contrasts <- as.data.frame(transposed_contrasts)


result_list <- lapply(names(models), function(model_name) {
  model <- models[[model_name]]
  ref_levels <- levels(ds$ad_present)[!is.na(levels(ds$ad_present))]
  ref_grid <- list(ad_present = ref_levels)
  emm <- emmeans(model, specs = pairwise ~ ad_present, ref_grid = ref_grid,
                 adjust = "tukey")
  fit_emm <- emm$emmeans
  fit_pairs <- emm$contrasts
  region_name <- model_name
  effect_size <- eff_size(emm, sigma = sigma(model), edf = df.residual(model)) %>% data.frame() %>%
    mutate_if(is.numeric, function(x)round(x, 6)) %>% 
    select(effect.size) %>% 
    pull()
  
  # store the fit_emm and fit_pairs results in a list
  list(region = region_name, fit_emm = fit_emm, fit_pairs = fit_pairs, effect_size = effect_size)
})



# Create a list of tables
pairs_table_list <- lapply(result_list, function(res) {
  cbind(res$region, as.data.frame(res$fit_pairs), res$effect_size)
})

# Combine all tables into a single table
pairs_combined_table <- do.call(rbind, pairs_table_list)

# Rename the columns
pairs_combined_table %<>% rename(`Estimated Difference` = estimate, `p-value` = p.value, `Effect Size` = `res$effect_size`) 


# replace values with abbreviations
pairs_combined_table <- pairs_combined_table %>% 
  mutate(`res$region` = recode(`res$region`, !!!abbreviations)) %>% 
  group_by(`res$region`) %>%
  select(-df, -t.ratio, -SE) %>% 
  mutate_if(is.numeric, function(x)round(x, 5))

# Pivot longer estimate, p.value and effect size to "stat"
pairs_combined_table %<>% pivot_longer(cols = -c(`res$region`, contrast), 
names_to = "stat", 
values_to = "value") %>% pivot_wider(names_from = contrast, values_from = value)

colnames(pairs_combined_table)
# Print the flextable
ft <- flextable(pairs_combined_table) %>%
  flextable::align(align = 'center', part = 'all') %>%
#  flextable::align(align = 'left', j = 'contrast', part = 'all') %>%
  set_header_labels(`res$region` = "Subfield",
#                    t.ratio = "t ratio",
#                    p.value = "p value",
                    stat = "Stat") %>%
  add_footer_row(., colwidths = ncol(pairs_combined_table), values = '') %>%
#  flextable::compose(., j = "df", part = "header", 
# #          value = as_paragraph(as_chunk("d.f.", props = italic_fp))) %>%
#   flextable::compose(., j = "contrast", part = "footer", 
#           value = as_paragraph('P values were adjusted using the Tukey method for comparing a family of 3 estimates')) %>%
  flextable::font(fontname = 'Times', part = 'all') %>%
  fontsize(size = 12, part = 'all') %>%
  autofit() %>%
 # bold(i = ~ p.value < 0.05) %>%
  padding(padding.top = 5, part = 'footer') %>% 
  merge_v(j = ~ `res$region`) %>% 
  theme_box() #%>% 
# bold(i = ~ stat == "p.value" & `Control - (LBD-AD)` < 0.05)

# Export the table to word 
ft %>% 
  save_as_docx(path = "reports/hippocampus_subfields.docx")
```

```

```{r}
# spot check individuals with highly asymmetric volumes to see if L-side and R-side were swapped

ds %>% mutate(percent_asymmetry = (abs(left_full_hippocampus_adjusted - right_full_hippocampus_adjusted))/
                (sum(left_full_hippocampus_adjusted + right_full_hippocampus_adjusted))) %>% 
  select(inddid, session_date, percent_asymmetry) %>% arrange(desc(percent_asymmetry))

```

# Subanalysis of autopsied cases

# Look at how well amyloid only distinguishes btwn groups (since some prior lit used only amyloid PET or amyloid CSF to determine AD positivity)

# is there a resiliency factor to point to? age, gender, disease duration, apoe4 positivity?

# Run verbal_memory.Rmd analysis

```{r}

report(sessionInfo())
```